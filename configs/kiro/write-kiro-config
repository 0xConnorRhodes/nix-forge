#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#   "pyyaml"
# ]
# ///
"""
Script Requirements:
- As a user, I want to maintain a user-editable list of Kiro extensions at the top of the file to specify which extensions should be installed.
- As a user, I want the script to install each extension in the list by running 'kiro --install-extension EXTENSION_NAME' for each item.
- As a user, I want to see success messages when extensions are installed successfully.
- As a user, I want to see error messages if extension installation fails or if the 'kiro' command is not found.
- As a user, I want to read a settings YAML file from '$HOME/code/nix-forge/configs/kiro/settings.yml'.
- As a user, I want to flatten the nested YAML structure into a single-level dictionary with dot-separated keys.
- As a user, I want to read a keybindings YAML file from '$HOME/code/nix-forge/configs/kiro/keybindings.yml'.
- As a user, I want to determine the correct output directory for 'Kiro' configuration based on my OS.
- As a user, I want the output directory to be '/Users/connor.rhodes/Library/Application Support/Kiro/User' if the platform is 'darwin'.
- As a user, I want the output directory to be '~/.config/Kiro/User' for all other platforms.
- As a user, I want to write the flattened settings data to 'settings.json' in the platform-specific config directory.
- As a user, I want to write the (non-flattened) keybindings data to 'keybindings.json' in the platform-specific config directory.
- As a user, I want the script to create the output directory if it doesn't exist.
- As a user, I want the script to print a success message to stdout when a file is written.
- As a user, I want the script to print errors to stderr if they occur.
"""

import json
import subprocess
import sys
import yaml
from pathlib import Path
from typing import Any, Dict, MutableMapping

# User-editable list of Kiro extensions to install
EXTENSIONS = [
    "auiworks.amvim",
]


def flatten_dict(
    d: MutableMapping[str, Any], parent_key: str = "", sep: str = "."
) -> Dict[str, Any]:
    """Flattens a nested dictionary into a single-level dictionary, but preserves language-specific settings."""
    items = []
    for k, v in d.items():
        new_key = f"{parent_key}{sep}{k}" if parent_key else k
        # Preserve language-specific settings (keys that start with [ and end with ])
        if isinstance(v, MutableMapping) and not (k.startswith('[') and k.endswith(']')):
            items.extend(flatten_dict(v, new_key, sep=sep).items())
        else:
            items.append((new_key, v))
    return dict(items)


def install_extensions() -> None:
    """Installs Kiro extensions from the EXTENSIONS list."""
    for extension in EXTENSIONS:
        try:
            subprocess.run(
                ["kiro", "--install-extension", extension],
                check=True,
                capture_output=True,
                text=True
            )
            print(f"Successfully installed Kiro extension: {extension}")
        except subprocess.CalledProcessError as e:
            print(f"Error installing extension {extension}: {e.stderr}", file=sys.stderr)
        except FileNotFoundError:
            print("Error: 'kiro' command not found. Please ensure Kiro is installed and in your PATH.", file=sys.stderr)
            break


def get_output_dir() -> Path:
    """Determines the correct config output directory based on the platform."""
    if sys.platform == "darwin":
        return Path("/Users/connor.rhodes/Library/Application Support/Kiro/User")

    return Path.home() / ".config" / "Kiro" / "User"


def process_file(
    input_path: Path, output_path: Path, flatten: bool = False
) -> None:
    """Reads a YAML file, processes it, and writes it to a JSON file."""
    with open(input_path, "r") as f:
        data = yaml.safe_load(f)

    if flatten:
        processed_data = flatten_dict(data)
    else:
        processed_data = data

    with open(output_path, "w") as f:
        json.dump(processed_data, f, indent=4)

    print(f"Successfully wrote Kiro config to: {output_path}")


def main():
    try:
        home_dir = Path.home()
        base_input_dir = home_dir / "code" / "nix-forge" / "configs" / "kiro"
        output_dir = get_output_dir()

        output_dir.mkdir(parents=True, exist_ok=True)

        settings_yaml_path = base_input_dir / "settings.yml"
        settings_json_path = output_dir / "settings.json"

        keybindings_yaml_path = base_input_dir / "keybindings.yml"
        keybindings_json_path = output_dir / "keybindings.json"

        # Process settings.json (with flattening)
        process_file(settings_yaml_path, settings_json_path, flatten=True)

        # Process keybindings.json (no flattening)
        process_file(keybindings_yaml_path, keybindings_json_path, flatten=False)

        # Install Kiro extensions
        install_extensions()

    except FileNotFoundError as e:
        print(f"Error: Input file not found. {e}", file=sys.stderr)
        sys.exit(1)
    except PermissionError as e:
        print(f"Error: Permission denied. {e}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"An unexpected error occurred: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
